<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evently Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
    </style>
</head>
<body class="text-gray-800">
    <div class="flex h-screen">
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-6 bg-white border-b border-gray-200">
                <div class="flex items-center space-x-8">
                    <a href="#" class="flex items-center space-x-2">
                        <svg class="h-7 w-7 text-gray-800" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                        <span class="text-xl font-bold text-gray-900">Evently</span>
                    </a>
                    <nav class="hidden md:flex items-center space-x-6 text-sm font-medium text-gray-600">
                        <a href="#" class="text-gray-900">Dashboard</a>
                        <a href="./sponsor-sponsorships.html" class="hover:text-gray-900">Sponsorships</a>
                        <a href="./sponsor-events-listing.html" class="hover:text-gray-900">Events</a>
                    </nav>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="./profile.html"><img class="h-10 w-10 rounded-full" src="https://i.pravatar.cc/150?img=1" alt="User Avatar"></a>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6 md:p-8">
                <div class="max-w-7xl mx-auto">
                    
                    <h2 id="welcome-message" class="text-3xl font-bold text-gray-900 mb-6">Dashboard Overview</h2>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gray-100 p-6 rounded-xl">
                            <p class="text-sm text-gray-600">Proposals Sent</p>
                            <p id="proposals-sent-stat" class="text-3xl font-semibold text-gray-900">0</p>
                        </div>
                        <div class="bg-gray-100 p-6 rounded-xl">
                            <p class="text-sm text-gray-600">Accepted Sponsorships</p>
                            <p id="accepted-sponsorships-stat" class="text-3xl font-semibold text-gray-900">0</p>
                        </div>
                        <div class="bg-gray-100 p-6 rounded-xl">
                            <p class="text-sm text-gray-600">Upcoming Events</p>
                            <p id="upcoming-events-stat" class="text-3xl font-semibold text-gray-900">0</p>
                        </div>
                        <div class="bg-gray-100 p-6 rounded-xl">
                            <p class="text-sm text-gray-600">Revenue Generated</p>
                            <p id="revenue-stat" class="text-3xl font-semibold text-gray-900">$0</p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-4 my-8">
                        <button class="bg-gray-200 text-gray-800 font-medium py-2 px-5 rounded-lg text-sm" id="eventListings">Event Listings</button>
                        <button class="bg-gray-200 text-gray-800 font-medium py-2 px-5 rounded-lg text-sm" id="sponsorPackage">Sponsorship Packages</button>
                        <button class="bg-gray-200 text-gray-800 font-medium py-2 px-5 rounded-lg text-sm" id="eventCalendar">Event Calendar</button>
                    </div>
                    
                    <div id="suggested-events-section" class="mb-12">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Suggested Events for You</h3>
                        <div id="suggested-events-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <!-- Suggested event cards will be inserted here -->
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-900 mb-6">Sponsorship Trends</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl border border-gray-200">
                             <h4 class="font-semibold">Sponsorship Growth</h4>
                             <div class="h-56"><canvas id="sponsorshipGrowthChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-gray-200">
                             <h4 class="font-semibold">Sponsorships by Category</h4>
                             <div class="h-56"><canvas id="sponsorshipByCategoryChart"></canvas></div>
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-900 mb-4">Your Upcoming Sponsored Events</h3>
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-xs text-gray-600 uppercase">
                                <tr>
                                    <th scope="col" class="px-6 py-4 font-medium">Event Name</th>
                                    <th scope="col" class="px-6 py-4 font-medium">Date</th>
                                    <th scope="col" class="px-6 py-4 font-medium">Location</th>
                                    <th scope="col" class="px-6 py-4 font-medium">Proposal Status</th>
                                </tr>
                            </thead>
                            <tbody id="events-table-body" class="divide-y divide-gray-200">
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- NAVIGATION ---
    document.querySelector('#eventListings').addEventListener('click', () => window.location.href = "./sponsor-events-listing.html");
    document.querySelector('#sponsorPackage').addEventListener('click', () => window.location.href = './sponsor-packages.html');
    document.querySelector('#eventCalendar').addEventListener('click', () => window.location.href = './sponsor-event-calendar.html');

    // --- DYNAMIC DATA ---
    fetch('http://localhost/event-management-backend/sponsorships/get_sponsor_dashboard_data.php', {
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            window.location.href = '../login-page.html';
            throw new Error('Authentication required.');
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('welcome-message').textContent = `Welcome, ${data.sponsor_name}`;
        document.getElementById('proposals-sent-stat').textContent = data.stats.proposals_sent;
        document.getElementById('accepted-sponsorships-stat').textContent = data.stats.accepted_sponsorships;
        document.getElementById('upcoming-events-stat').textContent = data.stats.upcoming_events_count;
        document.getElementById('revenue-stat').textContent = `$${data.stats.revenue_generated.toLocaleString('en-US')}`;
        
        renderEventsTable(data.upcoming_events_list);
        renderSuggestedEvents(data.suggested_events);
        renderSponsorshipGrowthChart(data.chart_data.sponsorship_growth);
        renderSponsorshipByCategoryChart(data.chart_data.sponsorship_by_category);
    })
    .catch(error => console.error('Error fetching dashboard data:', error));

    function renderEventsTable(events) {
        const tableBody = document.getElementById('events-table-body');
        tableBody.innerHTML = '';
        if (!events || events.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">You have no upcoming sponsored events.</td></tr>`;
            return;
        }
        const statusColors = {
            pending: 'bg-yellow-100 text-yellow-800',
            accepted: 'bg-green-100 text-green-800',
            rejected: 'bg-red-100 text-red-800'
        };
        events.forEach(event => {
            const formattedDate = new Date(event.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const statusColor = statusColors[event.status] || 'bg-gray-100 text-gray-800';
            const statusText = event.status.charAt(0).toUpperCase() + event.status.slice(1);
            const row = `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">${event.title}</td>
                    <td class="px-6 py-4">${formattedDate}</td>
                    <td class="px-6 py-4">${event.location}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-full ${statusColor}">${statusText}</span>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    function renderSuggestedEvents(events) {
        const grid = document.getElementById('suggested-events-grid');
        grid.innerHTML = '';
        if (!events || events.length === 0) {
            document.getElementById('suggested-events-section').style.display = 'none';
            return;
        }
        events.forEach(event => {
            const eventDate = new Date(event.date);
            const formattedDate = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const imageUrl = event.banner_image 
                ? `http://localhost/event-management-backend/${event.banner_image}` 
                : 'https://placehold.co/600x400/e2e8f0/64748b?text=Event';
            
            const card = `
                <a href="./sponsor-event-info.html?id=${event.id}" class="group block bg-white rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                    <img src="${imageUrl}" alt="${event.title}" class="w-full h-32 object-cover rounded-t-xl">
                    <div class="p-4">
                        <p class="text-xs font-semibold text-blue-600 uppercase">${event.category || 'General'}</p>
                        <h4 class="font-bold text-gray-900 mt-1">${event.title}</h4>
                        <p class="text-sm text-gray-600 mt-1">${formattedDate} &middot; ${event.location}</p>
                    </div>
                </a>
            `;
            grid.innerHTML += card;
        });
    }

    function renderSponsorshipGrowthChart(growthData) {
        const ctx = document.getElementById('sponsorshipGrowthChart').getContext('2d');
        const labels = growthData.map(item => new Date(item.month + '-02').toLocaleString('default', { month: 'short' }));
        const data = growthData.map(item => item.count);
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Accepted Sponsorships',
                    data: data,
                    fill: false, borderColor: '#4f46e5', tension: 0.4, pointRadius: 2
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function renderSponsorshipByCategoryChart(categoryData) {
        const ctx = document.getElementById('sponsorshipByCategoryChart').getContext('2d');
        const labels = categoryData.map(item => item.category);
        const data = categoryData.map(item => item.count);
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sponsorships',
                    data: data,
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                    borderRadius: 4, barPercentage: 0.6
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }
});
</script>

</body>
</html>
